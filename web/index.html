<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grid Generation - Last 7 Days</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; margin: 2em; background: #f9f9f9; }
        #chart-container { width: 100%; max-width: 900px; margin: 0 auto; background: #fff; padding: 2em; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        h1 { text-align: center; }
    </style>
</head>
<body>
    <h1>Grid Generation (Last 7 Days)</h1>
    <div style="margin-bottom: 1em;">
        <label>Granularity (minutes):
            <input type="number" id="granularityInput" value="30" min="30" step="30" style="width:60px;">
        </label>
        <label style="margin-left:1em;">Days:
            <input type="number" id="daysInput" value="7" min="1" max="30" style="width:60px;">
        </label>
        <button id="reloadBtn">Reload</button>
    </div>
    <div id="chart-container">
        <canvas id="genChart"></canvas>
        <h2>Generation as % of Total</h2>
        <canvas id="percentChart"></canvas>
        <h2>Average with Min/Max Range</h2>
        <canvas id="rangeChart"></canvas>
    </div>
    <script>
      function loadCharts() {
        const granularity = parseInt(document.getElementById('granularityInput').value, 10);
        const days = parseInt(document.getElementById('daysInput').value, 10);
        const end = new Date();
        end.setHours(0,0,0,0);
        end.setDate(end.getDate() + 1); // include today
        function isoDateNDaysAgo(n) {
          const d = new Date();
          d.setHours(0,0,0,0);
          d.setDate(d.getDate() - n);
          return d.toISOString().slice(0,19) + 'Z';
        }
        const start_time = isoDateNDaysAgo(days);
        const end_time = end.toISOString().slice(0,19) + 'Z';
        const apiUrl = `https://api.grid.gathered.consulting/api/generation/aggregated?start_time=${start_time}&end_time=${end_time}&granularity_minutes=${granularity}&sources=solar,wind_onshore,wind_offshore,fossil_gas`;

        fetch(apiUrl)
          .then(r => r.json())
          .then(data => {
            const labels = data.data.map(row => row.timestamp);
            const solar = data.data.map(row => row.sources.solar.avg);
            const wind = data.data.map(row => row.sources.wind_onshore.avg);
            const windOffshore = data.data.map(row => row.sources.wind_offshore.avg);
            const gas = data.data.map(row => row.sources.fossil_gas.avg);
            const ctx = document.getElementById('genChart').getContext('2d');
            if(window.generationChartObj) window.generationChartObj.destroy();
            window.generationChartObj = new Chart(ctx, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [
                  { label: 'Solar (MW)', data: solar, borderColor: '#f9c846', backgroundColor: '#f9c84622', fill: false },
                  { label: 'Wind Onshore (MW)', data: wind, borderColor: '#4a90e2', backgroundColor: '#4a90e222', fill: false },
                  { label: 'Wind Offshore (MW)', data: windOffshore, borderColor: '#00b894', backgroundColor: '#00b89422', fill: false },
                  { label: 'Gas (MW)', data: gas, borderColor: '#e17055', backgroundColor: '#e1705522', fill: false }
                ]
              },
              options: {
                responsive: true,
                plugins: { legend: { position: 'top' } },
                scales: { x: { display: true, title: { display: true, text: 'Timestamp' } }, y: { display: true, title: { display: true, text: 'MW' } } }
              }
            });

            // Percent chart
            fetch(apiUrl + '&as_percent=true')
              .then(r => r.json())
              .then(percentData => {
                const percentLabels = percentData.data.map(row => row.timestamp);
                const solarPercent = percentData.data.map(row => row.sources.solar.avg_percent);
                const windPercent = percentData.data.map(row => row.sources.wind_onshore.avg_percent);
                const windOffshorePercent = percentData.data.map(row => row.sources.wind_offshore.avg_percent);
                const gasPercent = percentData.data.map(row => row.sources.fossil_gas.avg_percent);
                const ctx2 = document.getElementById('percentChart').getContext('2d');
                if(window.percentChartObj) window.percentChartObj.destroy();
                window.percentChartObj = new Chart(ctx2, {
                  type: 'line',
                  data: {
                    labels: percentLabels,
                    datasets: [
                      { label: 'Solar (% of Total)', data: solarPercent, borderColor: '#f9c846', backgroundColor: '#f9c84622', fill: false },
                      { label: 'Wind Onshore (% of Total)', data: windPercent, borderColor: '#4a90e2', backgroundColor: '#4a90e222', fill: false },
                      { label: 'Wind Offshore (% of Total)', data: windOffshorePercent, borderColor: '#00b894', backgroundColor: '#00b89422', fill: false },
                      { label: 'Gas (% of Total)', data: gasPercent, borderColor: '#e17055', backgroundColor: '#e1705522', fill: false }
                    ]
                  },
                  options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: { x: { display: true, title: { display: true, text: 'Timestamp' } }, y: { display: true, title: { display: true, text: '% of Total' }, min: 0, max: 100 } }
                  }
                });
              });

            // Range chart (avg line, min/max area)
            fetch(apiUrl)
              .then(r => r.json())
              .then(data => {
                const labels = data.data.map(row => row.timestamp);
                const sources = ['solar', 'wind_onshore', 'wind_offshore', 'fossil_gas'];
                const colors = {
                  solar: '#f9c846',
                  wind_onshore: '#4a90e2',
                  wind_offshore: '#00b894',
                  fossil_gas: '#e17055'
                };
                const ctx3 = document.getElementById('rangeChart').getContext('2d');
                if(window.rangeChartObj) window.rangeChartObj.destroy();
                const datasets = [];
                sources.forEach((source) => {
                  // Min (low) line (invisible, for area fill)
                  datasets.push({
                    label: source + ' min',
                    data: data.data.map(row => row.sources[source].low),
                    borderColor: colors[source],
                    backgroundColor: colors[source] + '22',
                    fill: '+1',
                    pointRadius: 0,
                    borderWidth: 0,
                    order: 1
                  });
                  // Max (high) line (invisible, for area fill)
                  datasets.push({
                    label: source + ' max',
                    data: data.data.map(row => row.sources[source].high),
                    borderColor: colors[source],
                    backgroundColor: colors[source] + '22',
                    fill: false,
                    pointRadius: 0,
                    borderWidth: 0,
                    order: 1
                  });
                  // Avg line (visible)
                  datasets.push({
                    label: source + ' avg',
                    data: data.data.map(row => row.sources[source].avg),
                    borderColor: colors[source],
                    backgroundColor: colors[source] + '22',
                    fill: false,
                    pointRadius: 0,
                    borderWidth: 2,
                    order: 2,
                    tension: 0.2
                  });
                });
                window.rangeChartObj = new Chart(ctx3, {
                  type: 'line',
                  data: { labels, datasets },
                  options: {
                    responsive: true,
                    plugins: {
                      legend: {
                        display: true,
                        labels: {
                          filter: function(item, chart) {
                            // Only show avg lines in the legend
                            return item.text.endsWith('avg');
                          }
                        },
                        onClick: function(e, legendItem, legend) {
                          const chart = legend.chart;
                          const source = legendItem.text.replace(' avg', '');
                          // Find all datasets for this source (min, max, avg)
                          chart.data.datasets.forEach((ds, i) => {
                            if (ds.label.startsWith(source + ' ')) {
                              const meta = chart.getDatasetMeta(i);
                              // Toggle all three together based on avg line
                              if (legendItem.datasetIndex === i || ds.label.endsWith('min') || ds.label.endsWith('max')) {
                                meta.hidden = meta.hidden === null ? !chart.data.datasets[legendItem.datasetIndex].hidden : null;
                              }
                            }
                          });
                          chart.update();
                        }
                      }
                    },
                    elements: { point: { radius: 0 } },
                    scales: {
                      x: { display: true, title: { display: true, text: 'Timestamp' } },
                      y: { display: true, title: { display: true, text: 'MW' } }
                    }
                  }
                });
              });
          })
          .catch(err => {
            document.getElementById('chart-container').innerHTML = '<p style="color:red">Failed to load data from API.</p>';
            console.error(err);
          });
      }
      document.getElementById('reloadBtn').onclick = loadCharts;
      window.onload = loadCharts;
    </script>
</body>
</html> 